<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTAI Hub (Platform)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "@azure/msal-browser": "https://esm.sh/@azure/msal-browser@3.10.0",
        "@azure/msal-react": "https://esm.sh/@azure/msal-react@2.0.12?external=react,react-dom,@azure/msal-browser"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Hover Effekte */
        .hover-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        /* Drag & Drop Zone Styling */
        .drag-active { background-color: #eff6ff; border-color: #003B6E; border-style: solid; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { PublicClientApplication } from "@azure/msal-browser";
        import { MsalProvider, useMsal, useIsAuthenticated } from "@azure/msal-react";
        import { 
            LayoutDashboard, LogOut, Globe, CheckCircle, Menu, X, Calendar, 
            MessageSquare, Zap, Newspaper, Bell, ListTodo, Plus, Trash2, 
            CheckSquare, Loader2, RefreshCw, Briefcase, Bot, ArrowRight,
            ExternalLink, FileText, MapPin, Video, Users, Clock, AlertTriangle, CalendarClock, Database, Link as LinkIcon, Info,
            File, UploadCloud, Share2, FolderOpen, Link, UserPlus, Copy, Check
        } from 'lucide-react';

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center">
                            <h1 className="text-xl font-bold text-red-600 mb-4">Ein Fehler ist aufgetreten</h1>
                            <pre className="bg-slate-100 p-4 rounded text-left text-xs overflow-auto text-slate-700 border border-slate-300">
                                {this.state.error?.toString()}
                            </pre>
                            <button onClick={() => window.location.reload()} className="mt-6 bg-[#003B6E] text-white px-4 py-2 rounded">Neu laden</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- CONFIG ---
        const msalConfig = {
            auth: {
                clientId: "1bcff9d8-08fd-4807-9483-eeeab557d612",
                authority: "https://login.microsoftonline.com/7e77266e-8abb-4947-be1a-ce8f3bd5cb49",
                redirectUri: window.location.origin, 
            },
            cache: { cacheLocation: "localStorage" } 
        };

        const loginRequest = {
            scopes: ["User.Read", "Calendars.ReadWrite", "Tasks.ReadWrite", "Sites.Read.All", "Files.Read", "Files.Read.All", "Files.ReadWrite", "Files.ReadWrite.All"] 
        };

        const msalInstance = new PublicClientApplication(msalConfig);

        // --- HELPER: GRAPH API ---
        async function callMsGraph(instance, accounts, endpoint, method = "GET", body = null) {
            const request = { ...loginRequest, account: accounts[0] };
            try {
                const response = await instance.acquireTokenSilent(request);
                const headers = new Headers();
                headers.append("Authorization", `Bearer ${response.accessToken}`);
                if (body) headers.append("Content-Type", "application/json");
                const options = { method, headers, body: body ? JSON.stringify(body) : null };
                const res = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, options);
                if (!res.ok) throw new Error(res.statusText);
                const cType = res.headers.get("content-type");
                if (cType && cType.includes("application/json")) return await res.json();
                if (cType && cType.includes("image")) return await res.blob();
                return await res.text();
            } catch (e) { console.error(e); throw e; }
        }

        // --- COMPONENT: UPLOAD MODAL (MODERN UI) ---
        const UploadModal = ({ isOpen, onClose, file, onConfirm }) => {
            const [step, setStep] = useState('select'); // select, input, uploading, success
            const [shareType, setShareType] = useState(null); // 'internal', 'external'
            const [inputValue, setInputValue] = useState('');
            const [resultMessage, setResultMessage] = useState('');

            useEffect(() => {
                if (isOpen) { setStep('select'); setShareType(null); setInputValue(''); setResultMessage(''); }
            }, [isOpen]);

            if (!isOpen || !file) return null;

            const handleTypeSelect = (type) => {
                setShareType(type);
                setStep('input');
            };

            const handleSubmit = async () => {
                setStep('uploading');
                // Simulate API Call
                await new Promise(r => setTimeout(r, 1500));
                
                let msg = "";
                if (shareType === 'external') {
                    msg = "https://gtai.sharepoint.com/l/v/xk9s8d...";
                } else {
                    msg = `Freigabe für ${inputValue || 'das Team'} erteilt.`;
                }
                setResultMessage(msg);
                setStep('success');
                onConfirm(file, shareType, msg);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden slide-up border border-slate-200">
                        {/* Header */}
                        <div className="bg-[#003B6E] px-6 py-4 flex justify-between items-center text-white">
                            <h3 className="font-bold flex items-center gap-2"><Share2 size={18} /> Datei teilen</h3>
                            <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full transition"><X size={20} /></button>
                        </div>

                        {/* Content */}
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-6 p-3 bg-slate-50 rounded-lg border border-slate-100">
                                <div className="p-2 bg-white rounded border border-slate-200 text-[#003B6E]"><File size={20}/></div>
                                <div className="min-w-0">
                                    <p className="text-sm font-bold text-slate-800 truncate">{file.name}</p>
                                    <p className="text-xs text-slate-500">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                </div>
                            </div>

                            {step === 'select' && (
                                <div className="space-y-3">
                                    <p className="text-sm font-medium text-slate-700 mb-2">Wie möchtest du teilen?</p>
                                    <button onClick={() => handleTypeSelect('internal')} className="w-full flex items-center gap-4 p-4 rounded-xl border-2 border-slate-100 hover:border-[#003B6E] hover:bg-blue-50/50 transition text-left group">
                                        <div className="w-10 h-10 rounded-full bg-blue-100 text-[#003B6E] flex items-center justify-center group-hover:bg-[#003B6E] group-hover:text-white transition"><UserPlus size={20}/></div>
                                        <div>
                                            <p className="font-bold text-slate-800">Intern</p>
                                            <p className="text-xs text-slate-500">Bestimmte Personen oder Gruppen</p>
                                        </div>
                                    </button>
                                    <button onClick={() => handleTypeSelect('external')} className="w-full flex items-center gap-4 p-4 rounded-xl border-2 border-slate-100 hover:border-[#E4002B] hover:bg-red-50/50 transition text-left group">
                                        <div className="w-10 h-10 rounded-full bg-red-100 text-[#E4002B] flex items-center justify-center group-hover:bg-[#E4002B] group-hover:text-white transition"><LinkIcon size={20}/></div>
                                        <div>
                                            <p className="font-bold text-slate-800">Extern (Link)</p>
                                            <p className="text-xs text-slate-500">Öffentlicher Link für Partner</p>
                                        </div>
                                    </button>
                                </div>
                            )}

                            {step === 'input' && (
                                <div className="space-y-4 fade-in">
                                    <p className="text-sm font-medium text-slate-700">
                                        {shareType === 'external' ? 'Link Einstellungen' : 'Empfänger hinzufügen'}
                                    </p>
                                    
                                    {shareType === 'internal' ? (
                                        <input 
                                            autoFocus
                                            value={inputValue}
                                            onChange={e => setInputValue(e.target.value)}
                                            placeholder="Name, Gruppe oder E-Mail..." 
                                            className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-[#003B6E]"
                                        />
                                    ) : (
                                        <div className="p-3 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-200">
                                            Achtung: Externe Links sind für 30 Tage gültig.
                                        </div>
                                    )}

                                    <button onClick={handleSubmit} className="w-full bg-[#003B6E] text-white py-3 rounded-lg font-bold hover:bg-blue-900 transition flex items-center justify-center gap-2">
                                        Freigabe erstellen <ArrowRight size={18} />
                                    </button>
                                    <button onClick={() => setStep('select')} className="w-full text-slate-500 text-sm hover:text-slate-800 py-2">Zurück</button>
                                </div>
                            )}

                            {step === 'uploading' && (
                                <div className="text-center py-8 fade-in">
                                    <Loader2 className="w-12 h-12 text-[#003B6E] animate-spin mx-auto mb-4" />
                                    <p className="font-bold text-slate-800">Wird hochgeladen...</p>
                                    <p className="text-xs text-slate-500">Berechtigungen werden gesetzt</p>
                                </div>
                            )}

                            {step === 'success' && (
                                <div className="text-center py-4 fade-in">
                                    <div className="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><Check size={28} /></div>
                                    <h4 className="font-bold text-lg text-slate-800 mb-2">Erfolgreich geteilt!</h4>
                                    
                                    {shareType === 'external' ? (
                                        <div className="flex items-center gap-2 bg-slate-100 p-2 rounded border border-slate-200 mb-4">
                                            <input readOnly value={resultMessage} className="bg-transparent text-xs flex-1 outline-none text-slate-600" />
                                            <button className="text-[#003B6E] hover:bg-white p-1 rounded"><Copy size={14}/></button>
                                        </div>
                                    ) : (
                                        <p className="text-sm text-slate-600 mb-6">{resultMessage}</p>
                                    )}

                                    <button onClick={onClose} className="w-full bg-slate-100 text-slate-700 py-2 rounded-lg font-bold hover:bg-slate-200 transition">Schließen</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN COMPONENT ---
        const MainContent = () => {
            const { instance, accounts } = useMsal();
            const isAuthenticated = useIsAuthenticated();
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            // Data States
            const [userProfile, setUserProfile] = useState({ displayName: "", jobTitle: "", mail: "", photoUrl: null });
            const [calendarEvents, setCalendarEvents] = useState([]);
            const [plannerTasks, setPlannerTasks] = useState([]);
            const [isLoadingData, setIsLoadingData] = useState(false);
            
            // Document States
            const [sharedDocs, setSharedDocs] = useState([]);
            const [sharedByMeDocs, setSharedByMeDocs] = useState([]); // NEU: Trennung der Listen
            const [dragActive, setDragActive] = useState(false);
            
            // Modal States
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalFile, setModalFile] = useState(null);

            // Mock Data for Intranet
            const [intranetNews, setIntranetNews] = useState([
                { id: 1, title: "Neue Reiserichtlinien ab 2025", summary: "Anpassung der Verpflegungspauschalen.", date: "Heute", category: "HR", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 2, title: "Wartungsarbeiten SharePoint", summary: "Samstag 10-12 Uhr eingeschränkt.", date: "Gestern", category: "IT", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 3, title: "Erfolg auf der Hannover Messe", summary: "Besucherrekord am GTAI Stand.", date: "28.10.", category: "News", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 4, title: "Weihnachtsfeier 2024", summary: "Einladung und Anmeldung ab sofort möglich.", date: "25.10.", category: "Events", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 5, title: "Quartalszahlen Q3", summary: "Positive Entwicklung in den Kernmärkten.", date: "20.10.", category: "Management", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" }
            ]);

            const [todos, setTodos] = useState([]);
            const [newTodoText, setNewTodoText] = useState('');
            const [isBlocker, setIsBlocker] = useState(false);
            const [blockerDate, setBlockerDate] = useState(new Date().toISOString().slice(0, 10));
            const [blockerTimeStart, setBlockerTimeStart] = useState("09:00");
            const [blockerTimeEnd, setBlockerTimeEnd] = useState("10:00");
            const [tempDexterInput, setTempDexterInput] = useState('');

            // --- PERSISTENCE ---
            useEffect(() => {
                const savedTodos = localStorage.getItem('gtaiHub_todos');
                if (savedTodos) setTodos(JSON.parse(savedTodos));
                
                // Load Shared By Me from local mock persistence for demo
                const savedShares = localStorage.getItem('gtaiHub_shares');
                if (savedShares) setSharedByMeDocs(JSON.parse(savedShares));
            }, []);

            useEffect(() => {
                localStorage.setItem('gtaiHub_todos', JSON.stringify(todos));
            }, [todos]);
            
            useEffect(() => {
                localStorage.setItem('gtaiHub_shares', JSON.stringify(sharedByMeDocs));
            }, [sharedByMeDocs]);

            useEffect(() => {
                if (isAuthenticated && accounts[0]) loadAllData();
            }, [isAuthenticated, accounts]);

            // --- LOAD DATA ---
            const loadAllData = async () => {
                setIsLoadingData(true);
                try {
                    const profile = await callMsGraph(instance, accounts, "/me");
                    let photoUrl = null;
                    try {
                        const photoBlob = await callMsGraph(instance, accounts, "/me/photo/$value");
                        photoUrl = URL.createObjectURL(photoBlob);
                    } catch (e) {}
                    setUserProfile({ ...profile, photoUrl });

                    const start = new Date().toISOString();
                    const end = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(); 
                    const calData = await callMsGraph(instance, accounts, `/me/calendarview?startDateTime=${start}&endDateTime=${end}&$top=20&$orderby=start/dateTime`);
                    const enrichedEvents = (calData.value || []).map(evt => {
                        const d = new Date(evt.start.dateTime);
                        const label = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                        const teamsLink = evt.onlineMeeting?.joinUrl || evt.onlineMeetingUrl || null;
                        return { ...evt, dateObj: { date: d.toLocaleDateString('de-DE'), label: label }, teamsLink };
                    });
                    setCalendarEvents(enrichedEvents);

                    const taskData = await callMsGraph(instance, accounts, "/me/planner/tasks");
                    const enrichedTasks = (taskData.value || []).map(t => ({
                        ...t,
                        planName: ["Marketing Team", "IT Projekt Alpha", "HR Onboarding"][Math.floor(Math.random() * 3)]
                    }));
                    setPlannerTasks(enrichedTasks);

                    try {
                        const sharedData = await callMsGraph(instance, accounts, "/me/drive/sharedWithMe");
                        if (sharedData.value && sharedData.value.length > 0) {
                            setSharedDocs(sharedData.value.map(item => ({
                                id: item.id,
                                name: item.name,
                                sharedBy: item.createdBy?.user?.displayName || "Unbekannt",
                                date: new Date(item.lastModifiedDateTime).toLocaleDateString('de-DE'),
                                webUrl: item.webUrl
                            })));
                        } else { throw new Error("No docs"); }
                    } catch (docErr) {
                        setSharedDocs([
                            { id: 1, name: "Projektplan_2025.xlsx", sharedBy: "Max Mustermann", date: "Vor 2 Std", webUrl: "#" },
                            { id: 2, name: "Budget_Review_Q4.pdf", sharedBy: "Julia Sommer", date: "Gestern", webUrl: "#" },
                            { id: 3, name: "Marketing_Assets_V2.pptx", sharedBy: "Team Marketing", date: "28.10.", webUrl: "#" },
                        ]);
                    }
                } catch (e) { console.error(e); } finally { setIsLoadingData(false); }
            };

            // ... (Calendar blockers logic omitted for brevity, keep same) ...
            
            const handleAddTodo = (e) => { e.preventDefault(); if(newTodoText.trim()) { setTodos([...todos, {id:Date.now(), text:newTodoText, done:false}]); setNewTodoText(''); }};
            const toggleTodo = (id) => setTodos(todos.map(t => t.id === id ? { ...t, done: !t.done } : t));
            const handleDeleteTodo = (t) => setTodos(todos.filter(x => x.id !== t.id));

            // --- DOCUMENT UPLOAD HANDLERS ---
            const handleDrag = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") setDragActive(true);
                else if (e.type === "dragleave") setDragActive(false);
            };

            const handleDrop = (e) => {
                e.preventDefault(); e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    setModalFile(e.dataTransfer.files[0]);
                    setIsModalOpen(true);
                }
            };

            const handleFileSelect = (e) => {
                if(e.target.files && e.target.files[0]) {
                    setModalFile(e.target.files[0]);
                    setIsModalOpen(true);
                }
            };

            const handleUploadConfirm = (file, type, msg) => {
                // Add to "Shared BY ME" list (Correct Logic)
                const newDoc = {
                    id: Date.now(),
                    name: file.name,
                    sharedWith: type === 'external' ? 'Extern (Link)' : 'Intern (Gruppe)',
                    date: 'Gerade eben',
                    icon: 'file'
                };
                setSharedByMeDocs(prev => [newDoc, ...prev]);
                // Close modal is handled by user clicking close or we could auto close
            };

            const getFirstName = () => userProfile.displayName ? userProfile.displayName.split(',')[1]?.trim() || userProfile.displayName.split(' ')[0] : "Gast";

            if (!isAuthenticated) return ( <div className="p-10">Please Login</div> );

            const plannerStats = { total: plannerTasks.length, high: plannerTasks.filter(t=>t.priority<5).length, overdue: 0 };
            const groupedEvents = {}; // Simplified for brevity

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden">
                    {/* Modal */}
                    <UploadModal 
                        isOpen={isModalOpen} 
                        file={modalFile} 
                        onClose={() => setIsModalOpen(false)}
                        onConfirm={handleUploadConfirm}
                    />

                    {/* SIDEBAR (Shortened for brevity) */}
                    <aside className={`bg-[#003B6E] text-white flex flex-col ${isSidebarOpen ? 'w-64' : 'w-20'} transition-all duration-300 shadow-2xl z-30`}>
                         <div className="h-16 flex items-center px-6 border-b border-white/10 bg-[#003B6E]">
                            {isSidebarOpen && <span className="font-bold text-lg tracking-wide flex items-center gap-2"><Globe size={20} /> GTAI HUB</span>}
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="ml-auto p-1 hover:bg-white/10 rounded-lg"><Menu size={20} /></button>
                        </div>
                        <div className="flex-1 py-6 px-3 space-y-1">
                             <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 p-3 rounded-lg ${activeTab === 'dashboard' ? 'bg-white text-[#003B6E] font-bold' : 'hover:bg-white/10 text-blue-100'}`}><LayoutDashboard size={20} /> {isSidebarOpen && <span>Dashboard</span>}</button>
                             <button onClick={() => setActiveTab('documents')} className={`w-full flex items-center gap-3 p-3 rounded-lg ${activeTab === 'documents' ? 'bg-white text-[#003B6E] font-bold' : 'hover:bg-white/10 text-blue-100'}`}><FileText size={20} /> {isSidebarOpen && <span>Dokumente</span>}</button>
                             <button onClick={() => setActiveTab('copilot')} className={`w-full flex items-center gap-3 p-3 rounded-lg ${activeTab === 'copilot' ? 'bg-white text-[#003B6E] font-bold' : 'hover:bg-white/10 text-blue-100'}`}><Bot size={20} /> {isSidebarOpen && <span>Dexter</span>}</button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col h-full bg-[#f3f4f6]">
                         <header className="h-16 bg-white border-b flex items-center justify-between px-8 shadow-sm z-10 shrink-0">
                            <h2 className="text-xl font-bold text-slate-800 capitalize">
                                {activeTab === 'copilot' ? 'Dexter AI' : activeTab === 'documents' ? 'Dokumente & Teilen' : 'Dashboard'}
                            </h2>
                            <div className="flex items-center gap-4">
                                <span className="text-sm font-semibold text-slate-700">{userProfile.displayName}</span>
                            </div>
                        </header>

                        <div className="flex-1 overflow-hidden relative">
                            <div className="absolute inset-0 overflow-y-auto p-8">

                                {/* DASHBOARD */}
                                {activeTab === 'dashboard' && (
                                    <div className="max-w-7xl mx-auto space-y-8 fade-in">
                                         <div className="bg-[#003B6E] rounded-2xl p-8 text-white shadow-lg">
                                            <h1 className="text-3xl font-bold mb-3">Hallo {getFirstName()}!</h1>
                                            <p className="text-blue-200">Willkommen im GTAI Hub Beta.</p>
                                        </div>
                                        {/* Simple Dashboard Links */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div onClick={() => setActiveTab('documents')} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-[#003B6E] cursor-pointer hover:shadow-md transition">
                                                <h3 className="font-bold text-lg flex gap-2"><FileText /> Dokumente verwalten</h3>
                                                <p className="text-slate-500 text-sm mt-2">Dateien hochladen und sicher intern oder extern teilen.</p>
                                            </div>
                                            <div onClick={() => setActiveTab('copilot')} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-[#003B6E] cursor-pointer hover:shadow-md transition">
                                                <h3 className="font-bold text-lg flex gap-2"><Bot /> Dexter fragen</h3>
                                                <p className="text-slate-500 text-sm mt-2">KI-Unterstützung für Recherchen und Aufgaben.</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* DOCUMENTS */}
                                {activeTab === 'documents' && (
                                    <div className="max-w-6xl mx-auto h-[85vh] flex gap-6 fade-in">
                                        {/* Lists */}
                                        <div className="w-1/2 flex flex-col gap-6">
                                            {/* Shared WITH Me */}
                                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-1/2 overflow-hidden">
                                                <div className="p-4 border-b border-slate-100 bg-slate-50/50"><h3 className="font-bold text-lg text-[#003B6E] flex items-center gap-2"><Share2 size={20} /> Mit mir geteilt</h3></div>
                                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                                    {sharedDocs.map(doc => (
                                                        <a key={doc.id} href={doc.webUrl} target="_blank" className="flex items-center gap-3 p-3 rounded-lg border border-slate-100 hover:border-[#003B6E] hover:bg-blue-50/30 transition cursor-pointer group no-underline">
                                                            <div className="p-2 bg-white rounded-lg border border-slate-200 text-[#003B6E]"><FileText size={20} /></div>
                                                            <div className="flex-1 min-w-0">
                                                                <p className="font-medium text-slate-800 text-sm truncate">{doc.name}</p>
                                                                <p className="text-xs text-slate-500">Von {doc.sharedBy} • {doc.date}</p>
                                                            </div>
                                                        </a>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Shared BY Me (Fixed Logic) */}
                                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-1/2 overflow-hidden">
                                                <div className="p-4 border-b border-slate-100 bg-slate-50/50"><h3 className="font-bold text-lg text-[#003B6E] flex items-center gap-2"><FolderOpen size={20} /> Von mir geteilt</h3></div>
                                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                                    {sharedByMeDocs.length === 0 ? (
                                                        <div className="h-full flex items-center justify-center text-slate-400 italic text-sm">Noch keine Dokumente geteilt.</div>
                                                    ) : (
                                                        sharedByMeDocs.map(doc => (
                                                            <div key={doc.id} className="flex items-center gap-3 p-3 rounded-lg border border-slate-100 bg-slate-50/50">
                                                                <div className="p-2 bg-white rounded-lg border border-slate-200 text-slate-500"><FileText size={20} /></div>
                                                                <div className="flex-1 min-w-0">
                                                                    <p className="font-medium text-slate-800 text-sm truncate">{doc.name}</p>
                                                                    <p className="text-xs text-slate-500">An: {doc.sharedWith} • {doc.date}</p>
                                                                </div>
                                                                <div className="text-green-600"><CheckCircle size={16}/></div>
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Upload Zone */}
                                        <div className="w-1/2 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                                            <div className="p-6 border-b border-slate-100 bg-[#003B6E] text-white">
                                                <h2 className="text-xl font-bold flex items-center gap-3"><UploadCloud size={24} /> Datei teilen</h2>
                                                <p className="text-blue-100 text-xs mt-1">Sicherer Upload für interne und externe Partner.</p>
                                            </div>
                                            <div 
                                                className={`flex-1 m-6 border-2 border-dashed rounded-xl flex flex-col items-center justify-center transition-all ${dragActive ? 'drag-active' : 'border-slate-300 hover:border-[#003B6E] hover:bg-slate-50'}`}
                                                onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}
                                            >
                                                <div className="p-4 bg-blue-50 rounded-full text-[#003B6E] mb-4"><UploadCloud size={40} /></div>
                                                <p className="text-lg font-bold text-slate-700">Dateien hier ablegen</p>
                                                <p className="text-sm text-slate-400 mt-2 mb-6">oder klicken zum Auswählen</p>
                                                <input type="file" id="fileUpload" className="hidden" onChange={handleFileSelect} />
                                                <label htmlFor="fileUpload" className="bg-[#003B6E] text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-900 transition cursor-pointer shadow-md inline-flex items-center gap-2">Datei wählen</label>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* COPILOT (Fixed Iframe) */}
                                {activeTab === 'copilot' && (
                                    <div className="max-w-7xl mx-auto h-[85vh] bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden fade-in relative">
                                        <iframe 
                                            src="https://copilotstudio.microsoft.com/environments/Default-7e77266e-8abb-4947-be1a-ce8f3bd5cb49/bots/copilots_header_2cddc/webchat?__version__=2" 
                                            frameBorder="0" 
                                            allow="clipboard-write; microphone; camera; geolocation"
                                            sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                                            style={{ width: '100%', height: '100%' }}
                                            title="Dexter Copilot"
                                        ></iframe>
                                    </div>
                                )}

                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render( <ErrorBoundary><MsalProvider instance={msalInstance}><MainContent /></MsalProvider></ErrorBoundary> );
    </script>
</body>
</html>
