<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTAI Hub (Platform)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "@azure/msal-browser": "https://esm.sh/@azure/msal-browser@3.10.0",
        "@azure/msal-react": "https://esm.sh/@azure/msal-react@2.0.12?external=react,react-dom,@azure/msal-browser"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Hover Effekte */
        .hover-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        /* Custom Scrollbar f√ºr Chat */
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { PublicClientApplication } from "@azure/msal-browser";
        import { MsalProvider, useMsal, useIsAuthenticated } from "@azure/msal-react";
        import { 
            LayoutDashboard, LogOut, Globe, CheckCircle, Menu, X, Calendar, 
            MessageSquare, Zap, Newspaper, Bell, ListTodo, Plus, Trash2, 
            CheckSquare, Loader2, RefreshCw, Briefcase, Bot, ArrowRight,
            ExternalLink, FileText, MapPin, Video, Users, Clock, AlertTriangle, CalendarClock, Database, Link as LinkIcon, Info
        } from 'lucide-react';

        // --- ERROR BOUNDARY (Fixes White Screen Mystery) ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center">
                            <h1 className="text-xl font-bold text-red-600 mb-4">Ein Fehler ist aufgetreten</h1>
                            <pre className="bg-slate-100 p-4 rounded text-left text-xs overflow-auto text-slate-700 border border-slate-300">
                                {this.state.error?.toString()}
                            </pre>
                            <button onClick={() => window.location.reload()} className="mt-6 bg-[#003B6E] text-white px-4 py-2 rounded">Neu laden</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- CONFIG ---
        const msalConfig = {
            auth: {
                clientId: "1bcff9d8-08fd-4807-9483-eeeab557d612",
                authority: "https://login.microsoftonline.com/7e77266e-8abb-4947-be1a-ce8f3bd5cb49",
                redirectUri: window.location.origin, 
            },
            cache: { cacheLocation: "sessionStorage" }
        };

        const loginRequest = {
            scopes: ["User.Read", "Calendars.ReadWrite", "Tasks.ReadWrite", "Sites.Read.All"] 
        };

        const msalInstance = new PublicClientApplication(msalConfig);

        // --- HELPER: GRAPH API ---
        async function callMsGraph(instance, accounts, endpoint, method = "GET", body = null) {
            const request = { ...loginRequest, account: accounts[0] };
            try {
                const response = await instance.acquireTokenSilent(request);
                const headers = new Headers();
                headers.append("Authorization", `Bearer ${response.accessToken}`);
                if (body) headers.append("Content-Type", "application/json");
                const options = { method, headers, body: body ? JSON.stringify(body) : null };
                const res = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, options);
                if (!res.ok) throw new Error(res.statusText);
                const cType = res.headers.get("content-type");
                if (cType && cType.includes("application/json")) return await res.json();
                if (cType && cType.includes("image")) return await res.blob();
                return await res.text();
            } catch (e) { console.error(e); throw e; }
        }

        // --- COMPONENTS ---
        
        // Helper for To-Do Form Input (Defined outside to prevent re-render focus loss)
        const TodoInputForm = ({ 
            onSubmit, 
            newTodoText, setNewTodoText, 
            isBlocker, setIsBlocker, 
            blockerDate, setBlockerDate, 
            blockerTimeStart, setBlockerTimeStart, 
            blockerTimeEnd, setBlockerTimeEnd 
        }) => (
            <form onSubmit={onSubmit} className="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-inner">
                <div className="flex gap-2 mb-3">
                    <input 
                        value={newTodoText} 
                        onChange={e => setNewTodoText(e.target.value)} 
                        placeholder="Neue Aufgabe..." 
                        className="flex-1 px-3 py-2 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-[#003B6E] text-sm" 
                    />
                    <button className="bg-[#003B6E] text-white px-3 py-2 rounded-lg font-bold hover:bg-blue-900 transition shadow-sm"><Plus size={20} /></button>
                </div>
                <div className="flex flex-col gap-2">
                    <div className="flex items-center gap-2">
                        <input type="checkbox" id="blocker" checked={isBlocker} onChange={e => setIsBlocker(e.target.checked)} className="w-4 h-4 text-[#003B6E] rounded focus:ring-[#003B6E]" />
                        <label htmlFor="blocker" className="text-slate-700 text-sm font-medium cursor-pointer select-none flex items-center gap-1">Als <span className="text-[#E4002B] font-bold flex items-center gap-0.5"><CalendarClock size={12} /> Blocker</span> in Outlook</label>
                    </div>
                    {isBlocker && (
                        <div className="flex flex-wrap gap-2 fade-in">
                            <div className="flex items-center border rounded bg-white px-2 py-1 text-xs">
                                <input type="date" value={blockerDate} onChange={e => setBlockerDate(e.target.value)} className="outline-none text-slate-700 bg-transparent w-full" />
                            </div>
                            <div className="flex items-center border rounded bg-white px-2 py-1 text-xs">
                                <input type="time" value={blockerTimeStart} onChange={e => setBlockerTimeStart(e.target.value)} className="outline-none text-slate-700 bg-transparent" />
                            </div>
                            <span className="text-slate-400 self-center text-xs">-</span>
                            <div className="flex items-center border rounded bg-white px-2 py-1 text-xs">
                                <input type="time" value={blockerTimeEnd} onChange={e => setBlockerTimeEnd(e.target.value)} className="outline-none text-slate-700 bg-transparent" />
                            </div>
                        </div>
                    )}
                </div>
            </form>
        );

        // --- MAIN COMPONENT ---
        const MainContent = () => {
            const { instance, accounts } = useMsal();
            const isAuthenticated = useIsAuthenticated();
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            const messagesEndRef = useRef(null); 

            // Data States
            const [userProfile, setUserProfile] = useState({ displayName: "", jobTitle: "", mail: "", photoUrl: null });
            const [calendarEvents, setCalendarEvents] = useState([]);
            const [plannerTasks, setPlannerTasks] = useState([]);
            const [isLoadingData, setIsLoadingData] = useState(false);

            // Mock Data for Intranet
            const [intranetNews, setIntranetNews] = useState([
                { id: 1, title: "Neue Reiserichtlinien ab 2025", summary: "Anpassung der Verpflegungspauschalen.", date: "Heute", category: "HR", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 2, title: "Wartungsarbeiten SharePoint", summary: "Samstag 10-12 Uhr eingeschr√§nkt.", date: "Gestern", category: "IT", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 3, title: "Erfolg auf der Hannover Messe", summary: "Besucherrekord am GTAI Stand.", date: "28.10.", category: "News", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 4, title: "Weihnachtsfeier 2024", summary: "Einladung und Anmeldung ab sofort m√∂glich.", date: "25.10.", category: "Events", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 5, title: "Quartalszahlen Q3", summary: "Positive Entwicklung in den Kernm√§rkten.", date: "20.10.", category: "Management", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 6, title: "Neues IT-Ticket System", summary: "Ab November nutzen wir Jira Service Management.", date: "15.10.", category: "IT", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 7, title: "Gesundheitstag", summary: "Kostenlose Check-ups im Foyer.", date: "10.10.", category: "HR", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 8, title: "Webinar: KI im Export", summary: "Expertenrunde am Donnerstag.", date: "05.10.", category: "Webinar", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 9, title: "Kantinenplan November", summary: "Der neue Speiseplan ist online.", date: "01.10.", category: "Service", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" },
                { id: 10, title: "Jubil√§um: 10 Jahre Standort Bonn", summary: "R√ºckblick auf eine Erfolgsgeschichte.", date: "28.09.", category: "News", url: "https://gtai.sharepoint.com/sites/GTAI-Intranet" }
            ]);

            // Local States
            const [todos, setTodos] = useState([
                { id: 1, text: "Reisekostenabrechnung China fertigstellen", isBlocker: false, done: false },
            ]);
            const [newTodoText, setNewTodoText] = useState('');
            const [isBlocker, setIsBlocker] = useState(false);
            const [blockerDate, setBlockerDate] = useState(new Date().toISOString().slice(0, 10));
            const [blockerTimeStart, setBlockerTimeStart] = useState("09:00");
            const [blockerTimeEnd, setBlockerTimeEnd] = useState("10:00");
            
            // Chat States
            const [messages, setMessages] = useState([{ sender: 'bot', text: "Hallo! Ich bin Dexter, dein GTAI Copilot. Ich kann dir bei der Suche nach Dokumenten helfen, Termine planen oder Fragen zu internen Prozessen beantworten." }]);
            const [dexterInput, setDexterInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);

            // --- EFFECTS ---
            useEffect(() => {
                if (isAuthenticated && accounts[0]) loadAllData();
            }, [isAuthenticated, accounts]);

            useEffect(() => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [messages]);

            // --- LOAD DATA ---
            const loadAllData = async () => {
                setIsLoadingData(true);
                try {
                    const profile = await callMsGraph(instance, accounts, "/me");
                    let photoUrl = null;
                    try {
                        const photoBlob = await callMsGraph(instance, accounts, "/me/photo/$value");
                        photoUrl = URL.createObjectURL(photoBlob);
                    } catch (e) {}
                    setUserProfile({ ...profile, photoUrl });

                    // Calendar
                    const start = new Date().toISOString();
                    const end = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(); // 2 Weeks
                    const calData = await callMsGraph(instance, accounts, `/me/calendarview?startDateTime=${start}&endDateTime=${end}&$top=20&$orderby=start/dateTime`);
                    
                    const enrichedEvents = (calData.value || []).map(evt => {
                        const d = new Date(evt.start.dateTime);
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        const evtDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                        let label = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                        if (evtDate.getTime() === today.getTime()) label = 'Heute';
                        else if (evtDate.getTime() === tomorrow.getTime()) label = 'Morgen';
                        
                        const teamsLink = evt.onlineMeeting?.joinUrl || evt.onlineMeetingUrl || null;

                        return { ...evt, dateObj: { date: d.toLocaleDateString('de-DE'), label: label }, teamsLink };
                    });
                    setCalendarEvents(enrichedEvents);

                    // Planner
                    const taskData = await callMsGraph(instance, accounts, "/me/planner/tasks");
                    const enrichedTasks = (taskData.value || []).map(t => ({
                        ...t,
                        planName: ["Marketing Team", "IT Projekt Alpha", "HR Onboarding"][Math.floor(Math.random() * 3)]
                    }));
                    setPlannerTasks(enrichedTasks);
                } catch (e) { console.error(e); } finally { setIsLoadingData(false); }
            };

            const createCalendarBlocker = async (title, date, startTime, endTime) => {
                const startDateTime = new Date(`${date}T${startTime}:00`);
                const endDateTime = new Date(`${date}T${endTime}:00`);
                
                if (endDateTime <= startDateTime) {
                    alert("Das Ende muss nach dem Start liegen.");
                    return null;
                }

                const event = { 
                    subject: `üõ°Ô∏è FOKUS: ${title}`, 
                    start: { dateTime: startDateTime.toISOString(), timeZone: "UTC" }, 
                    end: { dateTime: endDateTime.toISOString(), timeZone: "UTC" },
                    showAs: 'busy'
                };
                try { 
                    const response = await callMsGraph(instance, accounts, "/me/events", "POST", event); 
                    loadAllData();
                    return response.id; // Return the new event ID
                } catch (e) { 
                    alert(e.message); 
                    return null;
                }
            };

            const deleteCalendarBlocker = async (eventId) => {
                if (!eventId) return;
                try {
                    await callMsGraph(instance, accounts, `/me/events/${eventId}`, "DELETE");
                    loadAllData();
                } catch (e) { console.error("Error deleting event:", e); }
            };

            const handleAddTodo = async (e) => {
                e.preventDefault();
                if (!newTodoText.trim()) return;
                
                let eventId = null;
                if (isBlocker) {
                    eventId = await createCalendarBlocker(newTodoText, blockerDate, blockerTimeStart, blockerTimeEnd);
                }

                setTodos([...todos, { 
                    id: Date.now(), 
                    text: newTodoText, 
                    isBlocker, 
                    done: false,
                    // Save blocker details for display and deletion
                    blockerDate,
                    blockerTimeStart,
                    blockerTimeEnd,
                    eventId
                }]);
                
                setNewTodoText(''); 
                setIsBlocker(false);
                // Reset times to default
                setBlockerDate(new Date().toISOString().slice(0, 10));
                setBlockerTimeStart("09:00");
                setBlockerTimeEnd("10:00");
            };
            
            const toggleTodo = (id) => {
                const todo = todos.find(t => t.id === id);
                if (todo && !todo.done && todo.eventId) {
                    // If marking as done and it has an event, delete the event from Outlook
                    deleteCalendarBlocker(todo.eventId);
                }
                setTodos(todos.map(t => t.id === id ? { ...t, done: !t.done } : t));
            };

            const handleDeleteTodo = (todo) => {
                if (todo.eventId) {
                    deleteCalendarBlocker(todo.eventId);
                }
                setTodos(todos.filter(x => x.id !== todo.id));
            };

            const handleChatSubmit = (e) => {
                e.preventDefault();
                if(!dexterInput.trim()) return;
                
                const userMsg = dexterInput;
                setMessages(prev => [...prev, {sender:'user', text: userMsg}]);
                setDexterInput('');
                setIsTyping(true);

                setTimeout(() => {
                    let response = "Ich habe das verstanden. Da ich aktuell im Demo-Modus bin, kann ich keine echten Aktionen ausf√ºhren, aber ich w√ºrde jetzt im Backend nach '" + userMsg + "' suchen.";
                    if (userMsg.toLowerCase().includes('termin')) response = "Ich kann gerne einen Termin f√ºr dich einstellen. Wann passt es dir am besten?";
                    if (userMsg.toLowerCase().includes('bericht') || userMsg.toLowerCase().includes('dokument')) response = "Ich habe 3 Dokumente zu diesem Thema im SharePoint gefunden. Soll ich sie zusammenfassen?";
                    
                    setMessages(prev => [...prev, {sender:'bot', text: response}]);
                    setIsTyping(false);
                }, 1500);
            };

            const getFirstName = () => userProfile.displayName ? userProfile.displayName.split(',')[1]?.trim() || userProfile.displayName.split(' ')[0] : "Gast";

            // --- LOGIN SCREEN ---
            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div className="bg-white p-12 rounded-lg shadow-xl text-center max-w-sm w-full border border-slate-100">
                            <h1 className="text-6xl font-extrabold text-[#001A44] mb-8 tracking-tighter">GTAI</h1>
                            
                            <h2 className="text-xl text-slate-700 mb-8 font-medium">GTAI-Hub Login</h2>
                            
                            {/* Updated Button to catch errors */}
                            <button onClick={() => instance.loginPopup(loginRequest).catch(e => console.log("Login cancelled/failed", e))} className="w-full bg-[#2F2F2F] text-white py-3 px-4 rounded-none hover:bg-black transition font-semibold flex justify-center items-center gap-3">
                                <div className="grid grid-cols-2 gap-0.5">
                                    <div className="w-2.5 h-2.5 bg-[#F25022]"></div>
                                    <div className="w-2.5 h-2.5 bg-[#7FBA00]"></div>
                                    <div className="w-2.5 h-2.5 bg-[#00A4EF]"></div>
                                    <div className="w-2.5 h-2.5 bg-[#FFB900]"></div>
                                </div>
                                Anmelden
                            </button>
                            
                            <p className="text-xs text-slate-400 mt-8">Du brauchst ein aktives GTAI-Konto.</p>
                        </div>
                    </div>
                );
            }
            
            // --- PLANNER STATS CALCULATION ---
            const plannerStats = {
                total: plannerTasks.length,
                high: plannerTasks.filter(t => t.priority < 5).length,
                overdue: plannerTasks.filter(t => t.dueDateTime && new Date(t.dueDateTime) < new Date()).length
            };

            // --- GROUPING FOR CALENDAR ---
            const groupedEvents = calendarEvents.reduce((groups, event) => {
                if (!event.dateObj) return groups; 
                const key = ['Heute', 'Morgen'].includes(event.dateObj.label) ? event.dateObj.label : event.dateObj.date;
                if (!groups[key]) groups[key] = { label: key, dateFull: event.dateObj.date, events: [] };
                groups[key].events.push(event);
                return groups;
            }, {});

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden">
                    {/* SIDEBAR */}
                    <aside className={`bg-[#003B6E] text-white flex flex-col transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-20'} z-30 shadow-2xl`}>
                        <div className="h-16 flex items-center px-6 border-b border-white/10 bg-[#003B6E]">
                            {isSidebarOpen && <span className="font-bold text-lg tracking-wide flex items-center gap-2"><Globe size={20} /> GTAI HUB</span>}
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="ml-auto p-1 hover:bg-white/10 rounded-lg"><Menu size={20} /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                            <p className={`px-3 text-xs font-bold text-blue-300 uppercase tracking-wider mb-2 ${!isSidebarOpen && 'text-center'}`}>{isSidebarOpen ? 'Men√º' : '‚Ä¢'}</p>
                            
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${activeTab === 'dashboard' ? 'bg-white text-[#003B6E] shadow-md font-semibold' : 'hover:bg-white/10 text-blue-100'} ${!isSidebarOpen && 'justify-center'}`}>
                                <LayoutDashboard size={20} /> {isSidebarOpen && <span>Dashboard</span>}
                            </button>
                            
                            <button onClick={() => setActiveTab('planner')} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${activeTab === 'planner' ? 'bg-white text-[#003B6E] shadow-md font-semibold' : 'hover:bg-white/10 text-blue-100'} ${!isSidebarOpen && 'justify-center'}`}>
                                <Users size={20} /> {isSidebarOpen && <span>Planner (Team)</span>}
                            </button>

                            <button onClick={() => setActiveTab('todo')} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${activeTab === 'todo' ? 'bg-white text-[#003B6E] shadow-md font-semibold' : 'hover:bg-white/10 text-blue-100'} ${!isSidebarOpen && 'justify-center'}`}>
                                <ListTodo size={20} /> {isSidebarOpen && <span>To-Do (Privat)</span>}
                            </button>
                            
                            <button onClick={() => setActiveTab('calendar')} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${activeTab === 'calendar' ? 'bg-white text-[#003B6E] shadow-md font-semibold' : 'hover:bg-white/10 text-blue-100'} ${!isSidebarOpen && 'justify-center'}`}>
                                <Calendar size={20} /> {isSidebarOpen && <span>Kalender</span>}
                            </button>

                            <button onClick={() => setActiveTab('news')} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${activeTab === 'news' ? 'bg-white text-[#003B6E] shadow-md font-semibold' : 'hover:bg-white/10 text-blue-100'} ${!isSidebarOpen && 'justify-center'}`}>
                                <Newspaper size={20} /> {isSidebarOpen && <span>GTAI News</span>}
                            </button>
                            
                            <button onClick={() => setActiveTab('copilot')} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${activeTab === 'copilot' ? 'bg-white text-[#003B6E] shadow-md font-semibold' : 'hover:bg-white/10 text-blue-100'} ${!isSidebarOpen && 'justify-center'}`}>
                                <Bot size={20} /> {isSidebarOpen && <span>Dexter</span>}
                            </button>

                            <div className="pt-6">
                                <p className={`px-3 text-xs font-bold text-blue-300 uppercase tracking-wider mb-2 ${!isSidebarOpen && 'text-center'}`}>{isSidebarOpen ? 'GTAI-Apps' : '‚Ä¢'}</p>
                                <a href="https://thankful-moss-0fc20ef03.3.azurestaticapps.net" target="_blank" className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 text-blue-100 transition-colors no-underline">
                                    <Database size={20} /> {isSidebarOpen && <span>Comres | Internal</span>}
                                </a>
                            </div>
                        </div>

                        <div className="p-4 border-t border-white/10 bg-black/10">
                            <div className="flex items-center gap-3">
                                {userProfile.photoUrl ? <img src={userProfile.photoUrl} className="w-10 h-10 rounded-full border border-white/30 object-cover" /> : <div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold">{getFirstName().substring(0,2)}</div>}
                                {isSidebarOpen && <div className="overflow-hidden"><p className="text-sm font-bold truncate">{getFirstName()}</p><button onClick={() => instance.logoutPopup()} className="text-xs text-blue-200 hover:text-white flex items-center gap-1"><LogOut size={12} /> Logout</button></div>}
                            </div>
                        </div>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 flex flex-col h-full bg-[#f3f4f6]">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-8 shadow-sm z-10 shrink-0">
                            <h2 className="text-xl font-bold text-slate-800 capitalize flex items-center gap-2">
                                {activeTab === 'copilot' ? <Bot className="text-[#003B6E]" /> : activeTab === 'dashboard' ? <LayoutDashboard className="text-[#003B6E]" /> : activeTab === 'planner' ? <Users className="text-[#003B6E]" /> : activeTab === 'todo' ? <ListTodo className="text-[#003B6E]" /> : activeTab === 'calendar' ? <Calendar className="text-[#003B6E]" /> : activeTab === 'news' ? <Newspaper className="text-[#003B6E]" /> : null}
                                {activeTab === 'copilot' ? 'Dexter AI' : activeTab === 'planner' ? 'Planner (Teamaufgaben)' : activeTab === 'todo' ? 'Meine To-Dos' : activeTab === 'calendar' ? 'Mein Kalender' : activeTab === 'news' ? 'GTAI News' : 'Dashboard'}
                            </h2>
                            <div className="flex items-center gap-4">
                                <button onClick={loadAllData} className={`p-2 rounded-full hover:bg-slate-100 text-slate-500 transition ${isLoadingData && 'animate-spin text-[#003B6E]'}`}><RefreshCw size={20}/></button>
                                <div className="h-6 w-px bg-slate-200"></div>
                                <div className="flex flex-col items-end">
                                    <span className="text-sm font-semibold text-slate-700">{userProfile.displayName || "Gast"}</span>
                                    <span className="text-xs text-slate-500">{userProfile.jobTitle || "Mitarbeiter"}</span>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-hidden relative">
                            <div className="absolute inset-0 overflow-y-auto p-8">
                            
                            {/* ================= DASHBOARD VIEW ================= */}
                            {activeTab === 'dashboard' && (
                                <div className="max-w-7xl mx-auto space-y-8 fade-in">
                                    {/* HERO SECTION */}
                                    <div className="bg-[#003B6E] rounded-2xl p-8 text-white shadow-lg relative overflow-hidden">
                                        <div className="relative z-10 max-w-3xl">
                                            <h1 className="text-3xl font-bold mb-3">Hallo {getFirstName()}!</h1>
                                            <div className="flex items-start gap-3 mb-6 p-3 bg-white/10 rounded-lg border border-white/20 backdrop-blur-sm">
                                                <Info className="shrink-0 text-blue-200 mt-0.5" size={20} />
                                                <p className="text-blue-100 text-sm leading-relaxed">
                                                    Das ist eine <strong>BETA</strong>. Bei Fragen oder Anregungen melde dich bei <strong>Sandra aus dem GTAI-KI Team</strong>.
                                                </p>
                                            </div>
                                            
                                            <form onSubmit={(e) => { e.preventDefault(); setActiveTab('copilot'); setMessages(p => [...p, {sender:'user', text: dexterInput}]); setTimeout(()=> { setMessages(p=>[...p, {sender:'bot', text: 'Wie kann ich helfen?'}])}, 1000); }} className="flex gap-0 shadow-xl rounded-xl overflow-hidden w-full max-w-xl">
                                                <div className="relative flex-1 bg-white">
                                                    <Bot className="absolute left-4 top-3.5 text-slate-400" size={20} />
                                                    <input value={dexterInput} onChange={e => setDexterInput(e.target.value)} placeholder="Frag Dexter etwas..." className="w-full pl-12 pr-4 py-3 text-slate-800 outline-none" />
                                                </div>
                                                <button className="bg-[#E4002B] text-white px-6 font-bold hover:bg-[#c20024] transition flex items-center gap-2">
                                                    Go <ArrowRight size={18} />
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    {/* CONTENT GRID - CHANGED TO 3 COLUMNS, TASKS LEFT (2/3), CALENDAR RIGHT (1/3) */}
                                    <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                                        
                                        {/* LEFT COLUMN (WIDE): SPLIT WIDGETS (PLANNER + TO-DO) */}
                                        <div className="xl:col-span-2 flex flex-col gap-6 h-full order-1">
                                            
                                            {/* TO-DO CARD (Now on top) */}
                                            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 hover-card flex flex-col flex-1 overflow-hidden">
                                                <div className="p-4 border-b border-slate-50 flex justify-between items-center bg-blue-50/30">
                                                    <h3 className="font-bold text-md flex items-center gap-2 text-[#003B6E]"><ListTodo size={18} /> To-Do (Privat)</h3>
                                                    <button onClick={() => setActiveTab('todo')} className="text-xs font-medium text-slate-400 hover:text-[#003B6E] transition"><ArrowRight size={16} /></button>
                                                </div>
                                                <div className="p-4 flex-1 flex flex-col">
                                                    <TodoInputForm 
                                                        onSubmit={handleAddTodo}
                                                        newTodoText={newTodoText}
                                                        setNewTodoText={setNewTodoText}
                                                        isBlocker={isBlocker}
                                                        setIsBlocker={setIsBlocker}
                                                        blockerDate={blockerDate}
                                                        setBlockerDate={setBlockerDate}
                                                        blockerTimeStart={blockerTimeStart}
                                                        setBlockerTimeStart={setBlockerTimeStart}
                                                        blockerTimeEnd={blockerTimeEnd}
                                                        setBlockerTimeEnd={setBlockerTimeEnd}
                                                    />
                                                    <ul className="space-y-2 mt-3 overflow-y-auto max-h-[150px] scrollbar-hide">
                                                        {todos.map(t => (
                                                            <li key={t.id} onClick={() => toggleTodo(t.id)} className="flex items-center gap-3 p-2 hover:bg-slate-50 rounded border border-transparent hover:border-slate-100 transition cursor-pointer group/todo">
                                                                <div className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${t.isBlocker ? 'border-[#E4002B]' : 'border-slate-300 group-hover/item:border-[#003B6E]'} ${t.done ? 'bg-slate-200 border-slate-200' : 'bg-white'}`}>
                                                                    {t.done ? <CheckSquare size={16} className="text-slate-500" /> : (t.isBlocker && <div className="w-3 h-3 bg-[#E4002B] rounded-full"></div>)}
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <span className={`block text-sm break-words leading-snug transition-all ${t.done ? 'line-through text-slate-400' : 'text-slate-700'}`}>{t.text}</span>
                                                                    {t.isBlocker && !t.done && (
                                                                        <div className="flex items-center gap-2 mt-1">
                                                                            <span className="text-[#E4002B] bg-red-50 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider border border-red-100 uppercase">Blocker</span>
                                                                            {t.blockerDate && (
                                                                                <span className="text-[10px] text-red-500 font-medium flex items-center gap-1">
                                                                                    {new Date(t.blockerDate).toLocaleDateString('de-DE')} | {t.blockerTimeStart} - {t.blockerTimeEnd}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteTodo(t); }} className="text-slate-300 hover:text-[#E4002B] p-2 transition"><Trash2 size={20}/></button>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            </div>

                                            {/* PLANNER CARD (Now below) */}
                                            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 hover-card flex flex-col flex-1 overflow-hidden">
                                                <div className="p-4 border-b border-slate-50 flex justify-between items-center bg-blue-50/30">
                                                    <div className="flex items-center gap-3">
                                                         <h3 className="font-bold text-md flex items-center gap-2 text-[#003B6E]"><Users size={18} /> Planner (Team)</h3>
                                                         {(plannerStats.high > 0 || plannerStats.overdue > 0) && (
                                                            <div className="flex gap-2">
                                                                {plannerStats.high > 0 && (
                                                                    <span className="text-[10px] font-bold text-[#E4002B] bg-red-50 border border-red-100 px-1.5 py-0.5 rounded-full flex items-center gap-1" title="Hohe Priorit√§t">
                                                                        <AlertTriangle size={10} /> {plannerStats.high}
                                                                    </span>
                                                                )}
                                                                {plannerStats.overdue > 0 && (
                                                                    <span className="text-[10px] font-bold text-[#E4002B] bg-red-50 border border-red-100 px-1.5 py-0.5 rounded-full flex items-center gap-1" title="√úberf√§llig">
                                                                        <Clock size={10} /> {plannerStats.overdue}
                                                                    </span>
                                                                )}
                                                            </div>
                                                         )}
                                                    </div>
                                                    <button onClick={() => setActiveTab('planner')} className="text-xs font-medium text-slate-400 hover:text-[#003B6E] transition"><ArrowRight size={16} /></button>
                                                </div>
                                                <div className="p-4 flex-1 overflow-y-auto max-h-[250px] scrollbar-hide">
                                                    <div className="space-y-2">
                                                        {plannerTasks.length === 0 ? <p className="text-slate-400 italic text-sm">Alles erledigt!</p> : 
                                                            plannerTasks.slice(0, 3).map(task => (
                                                            <div key={task.id} className="flex items-start gap-3 p-2.5 rounded-lg border border-slate-100 hover:bg-slate-50 transition group cursor-pointer">
                                                                <div className="mt-1 text-slate-300 group-hover:text-[#003B6E] transition"><CheckCircle size={14} /></div>
                                                                <div className="flex-1 min-w-0">
                                                                    <p className="text-sm font-medium text-slate-800 leading-snug break-words">{task.title}</p>
                                                                    <p className="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                                                        <span className="bg-blue-100 text-blue-700 px-1.5 rounded font-bold text-[10px] uppercase">{task.planName}</span>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                        {/* RIGHT COLUMN (NARROW): KALENDER */}
                                        <div className="xl:col-span-1 bg-white rounded-2xl shadow-sm border border-slate-100 hover-card flex flex-col h-full overflow-hidden group order-2">
                                            <div className="p-6 border-b border-slate-50 flex justify-between items-center">
                                                <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Calendar className="text-[#003B6E]" /> Termine</h3>
                                                <button onClick={() => setActiveTab('calendar')} className="text-xs font-medium text-[#003B6E] hover:bg-blue-50 px-3 py-1.5 rounded-full transition flex items-center gap-1">Alle anzeigen <ArrowRight size={12} /></button>
                                            </div>
                                            <div className="p-6 space-y-5 flex-1">
                                                {calendarEvents.length === 0 ? <p className="text-slate-400 italic">Keine Termine heute.</p> : 
                                                 calendarEvents.slice(0, 5).map(evt => (
                                                    <div key={evt.id} className="flex gap-4 group/item">
                                                        <div className="flex flex-col items-center min-w-[60px] pt-1">
                                                            <span className="text-sm font-bold text-slate-700">{new Date(evt.start.dateTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                                            <div className="h-full w-px bg-slate-200 mt-2 group-last/item:hidden"></div>
                                                        </div>
                                                        <div className="pb-5 flex-1">
                                                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100 hover:border-blue-200 transition cursor-pointer">
                                                                <h4 className="font-semibold text-slate-800 text-sm leading-snug mb-1">{evt.subject}</h4>
                                                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                                                    <span className="flex items-center gap-1"><Clock size={12} /> {Math.round((new Date(evt.end.dateTime) - new Date(evt.start.dateTime))/60000)} min</span>
                                                                    <span className="flex items-center gap-1"><MapPin size={12} /> {evt.location?.displayName || "Online"}</span>
                                                                </div>
                                                                {evt.teamsLink && (
                                                                    <div className="mt-2">
                                                                        <a href={evt.teamsLink} target="_blank" className="inline-flex items-center gap-1 text-[10px] font-bold text-white bg-[#5b5fc7] hover:bg-[#4f52b2] px-2 py-1 rounded transition">
                                                                            <Video size={10} /> Jetzt teilnehmen
                                                                        </a>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* NEWS WIDGET (FULL WIDTH BOTTOM) */}
                                        <div className="xl:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col h-full order-3">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Globe className="text-[#003B6E]" /> GTAI Intranet News</h3>
                                                <button onClick={() => setActiveTab('news')} className="text-xs font-medium text-[#003B6E] hover:bg-blue-50 px-3 py-1.5 rounded-full transition">Alle ansehen</button>
                                            </div>
                                            <div className="space-y-4 flex-1">
                                                {intranetNews.slice(0,3).map(news => (
                                                    <a key={news.id} href={news.url} target="_blank" className="block group/news relative pl-4">
                                                        <div className="absolute left-0 top-1 bottom-1 w-1 bg-[#003B6E]/20 group-hover/news:bg-[#E4002B] transition rounded-full"></div>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <span className="text-xs font-bold uppercase tracking-wider text-slate-400">{news.date}</span>
                                                            <span className="text-[10px] font-bold uppercase tracking-wider text-[#003B6E] bg-blue-50 px-2 py-1 rounded">{news.category}</span>
                                                        </div>
                                                        <h4 className="font-bold text-slate-800 text-sm group-hover/news:text-[#003B6E] transition break-words">{news.title}</h4>
                                                        <p className="text-sm text-slate-500">{news.summary}</p>
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* ================= DEXTER COPILOT VIEW ================= */}
                            {activeTab === 'copilot' && (
                                <div className="max-w-5xl mx-auto h-[85vh] flex flex-col bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden fade-in">
                                    <div className="p-6 border-b border-slate-100 flex items-center gap-4 bg-slate-50/80 backdrop-blur">
                                        <div className="w-12 h-12 bg-[#003B6E] rounded-full flex items-center justify-center shadow-lg text-white ring-4 ring-blue-50">
                                            <Bot size={24} />
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-xl text-slate-800">Dexter</h3>
                                            <p className="text-xs text-slate-500 flex items-center gap-2 mt-0.5">
                                                <span className="flex items-center gap-1 bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold"><div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div> Online</span> 
                                                <span className="text-slate-400">|</span> 
                                                GTAI Copilot v0.9 (Beta)
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-[#f8fafc] chat-scroll">
                                        {messages.map((m, i) => (
                                            <div key={i} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-[80%] p-5 rounded-2xl shadow-sm text-sm leading-relaxed relative ${m.sender === 'user' ? 'bg-[#003B6E] text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-200 rounded-tl-none'}`}>
                                                    {m.text}
                                                </div>
                                            </div>
                                        ))}
                                        {isTyping && (
                                            <div className="flex justify-start">
                                                <div className="bg-white border border-slate-200 p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-1 items-center">
                                                    <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                                                    <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-100"></div>
                                                    <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-200"></div>
                                                </div>
                                            </div>
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                    <div className="p-4 bg-white border-t border-slate-100">
                                        <form onSubmit={handleChatSubmit} className="relative max-w-4xl mx-auto">
                                            <input value={dexterInput} onChange={e=>setDexterInput(e.target.value)} className="w-full bg-slate-100 border-0 rounded-xl px-5 py-4 pr-16 text-slate-800 focus:ring-2 focus:ring-[#003B6E] outline-none transition placeholder:text-slate-400" placeholder="Schreib eine Nachricht an Dexter..." disabled={isTyping} />
                                            <button type="submit" disabled={isTyping || !dexterInput.trim()} className="absolute right-2 top-2 p-2 bg-[#003B6E] text-white rounded-lg hover:bg-blue-900 transition disabled:opacity-50 disabled:cursor-not-allowed"><ArrowRight size={20} /></button>
                                        </form>
                                        <div className="text-center mt-2">
                                            <p className="text-[10px] text-slate-400">KI-generierte Inhalte k√∂nnen fehlerhaft sein. Bitte √ºberpr√ºfe wichtige Informationen.</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ================= PLANNER FULL VIEW ================= */}
                            {activeTab === 'planner' && (
                                <div className="max-w-6xl mx-auto fade-in h-full flex flex-col space-y-6">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-2xl font-bold text-[#003B6E] flex items-center gap-3"><Users size={28} /> Planner (Teams)</h2>
                                        <a href="https://tasks.office.com" target="_blank" className="flex items-center gap-2 text-sm text-[#003B6E] font-medium hover:underline">√ñffnen in Web <ExternalLink size={14} /></a>
                                    </div>

                                    {/* Statistics Bar */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                                            <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Offen</p><p className="text-3xl font-bold text-slate-800">{plannerStats.total}</p></div>
                                            <div className="p-3 bg-blue-50 rounded-full text-[#003B6E]"><CheckCircle size={24} /></div>
                                        </div>
                                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                                            <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Wichtig</p><p className={`text-3xl font-bold ${plannerStats.high > 0 ? 'text-[#E4002B]' : 'text-slate-800'}`}>{plannerStats.high}</p></div>
                                            <div className={`p-3 rounded-full ${plannerStats.high > 0 ? 'bg-red-50 text-[#E4002B]' : 'bg-slate-50 text-slate-400'}`}><AlertTriangle size={24} /></div>
                                        </div>
                                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                                            <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">√úberf√§llig</p><p className={`text-3xl font-bold ${plannerStats.overdue > 0 ? 'text-[#E4002B]' : 'text-slate-800'}`}>{plannerStats.overdue}</p></div>
                                            <div className={`p-3 rounded-full ${plannerStats.overdue > 0 ? 'bg-red-50 text-[#E4002B]' : 'bg-slate-50 text-slate-400'}`}><Clock size={24} /></div>
                                        </div>
                                    </div>

                                    {/* List */}
                                    <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-100 flex-1 overflow-y-auto">
                                        {isLoadingData ? <div className="flex justify-center p-10"><Loader2 className="animate-spin text-[#003B6E]" size={32} /></div> : (
                                            <div className="space-y-3">
                                                {plannerTasks.length === 0 ? <p className="text-slate-400">Keine Aufgaben gefunden.</p> : plannerTasks.map(task => (
                                                    <div key={task.id} className="p-4 rounded-lg border border-slate-100 hover:border-[#003B6E] transition bg-white hover:shadow-md group flex items-center justify-between">
                                                        <div className="flex items-center gap-4">
                                                            <div className={`w-1 h-12 rounded-full ${task.priority < 5 ? 'bg-[#E4002B]' : 'bg-slate-200'}`}></div>
                                                            <div>
                                                                <h4 className="font-bold text-slate-800 text-lg">{task.title}</h4>
                                                                <div className="flex items-center gap-3 mt-1">
                                                                    <span className="text-xs bg-blue-50 text-[#003B6E] px-2 py-0.5 rounded font-bold uppercase tracking-wide">{task.planName}</span>
                                                                    {task.dueDateTime && <span className={`text-xs flex items-center gap-1 font-medium ${new Date(task.dueDateTime) < new Date() ? 'text-[#E4002B]' : 'text-slate-500'}`}><Clock size={12}/> {new Date(task.dueDateTime).toLocaleDateString()}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <a href="https://tasks.office.com" target="_blank" className="text-slate-300 hover:text-[#003B6E] p-2"><ExternalLink size={20} /></a>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* ================= TO-DO FULL VIEW ================= */}
                            {activeTab === 'todo' && (
                                <div className="bg-white p-8 rounded-xl shadow border border-slate-200 h-full flex flex-col max-w-4xl mx-auto fade-in">
                                    <div className="flex justify-between items-center mb-8">
                                        <h2 className="text-2xl font-bold text-[#003B6E] flex items-center gap-3"><ListTodo size={28} /> Meine Fokus-Liste</h2>
                                        <span className="text-sm text-slate-400">Synchronisiert mit Microsoft To Do</span>
                                    </div>
                                    
                                    <div className="mb-8">
                                        <TodoInputForm 
                                            onSubmit={handleAddTodo}
                                            newTodoText={newTodoText}
                                            setNewTodoText={setNewTodoText}
                                            isBlocker={isBlocker}
                                            setIsBlocker={setIsBlocker}
                                            blockerDate={blockerDate}
                                            setBlockerDate={setBlockerDate}
                                            blockerTimeStart={blockerTimeStart}
                                            setBlockerTimeStart={setBlockerTimeStart}
                                            blockerTimeEnd={blockerTimeEnd}
                                            setBlockerTimeEnd={setBlockerTimeEnd}
                                        />
                                    </div>

                                    <div className="space-y-3 overflow-y-auto flex-1">
                                        {todos.map(t => (
                                            <div key={t.id} onClick={() => toggleTodo(t.id)} className={`flex justify-between p-4 border rounded-xl items-center transition shadow-sm cursor-pointer group/item ${t.done ? 'bg-slate-50 border-slate-100 opacity-50' : 'bg-white border-slate-200 hover:border-[#003B6E] hover:shadow-md'}`}>
                                                <div className="flex items-center gap-4 flex-1">
                                                    <div className={`w-6 h-6 rounded border-2 flex items-center justify-center transition-colors ${t.isBlocker ? 'border-[#E4002B]' : 'border-slate-300 group-hover/item:border-[#003B6E]'} ${t.done ? 'bg-slate-200 border-slate-200' : 'bg-white'}`}>
                                                        {t.done ? <CheckSquare size={16} className="text-slate-500" /> : (t.isBlocker && <div className="w-3 h-3 bg-[#E4002B] rounded-full"></div>)}
                                                    </div>
                                                    <span className={`text-lg font-medium break-words flex-1 pr-4 transition-all ${t.done ? 'line-through text-slate-400' : 'text-slate-700'}`}>{t.text}</span>
                                                    {t.isBlocker && !t.done && <span className="text-[#E4002B] bg-red-50 px-2 py-1 rounded text-xs font-bold tracking-wider border border-red-100">BLOCKER</span>}
                                                </div>
                                                <button onClick={(e) => { e.stopPropagation(); setTodos(todos.filter(x=>x.id !== t.id)); }} className="text-slate-300 hover:text-[#E4002B] p-2 transition"><Trash2 size={20}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* ================= CALENDAR FULL VIEW ================= */}
                            {activeTab === 'calendar' && (
                                <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col min-h-[80vh] fade-in">
                                    <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl">
                                        <h2 className="text-2xl font-bold text-[#003B6E] flex items-center gap-3"><Calendar size={28} /> Dein Kalender</h2>
                                        <a href="https://outlook.office.com/calendar/" target="_blank" className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50 transition flex items-center gap-2">
                                            In Outlook √∂ffnen <ExternalLink size={14} />
                                        </a>
                                    </div>
                                    <div className="p-8 space-y-8 flex-1">
                                        {Object.keys(groupedEvents).length === 0 ? (
                                            <div className="text-center py-20">
                                                <Calendar className="w-16 h-16 text-slate-200 mx-auto mb-4" />
                                                <p className="text-slate-500">Keine Termine in den n√§chsten 14 Tagen.</p>
                                            </div>
                                        ) : (
                                            Object.keys(groupedEvents).map(key => (
                                                <div key={key}>
                                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 border-b border-slate-100 pb-2">{key} <span className="text-slate-300 font-normal ml-2">{groupedEvents[key].dateFull}</span></h3>
                                                    <div className="space-y-4">
                                                        {groupedEvents[key].events.map(evt => (
                                                            <div key={evt.id} className="flex gap-6 group">
                                                                <div className="w-16 text-right pt-2">
                                                                    <span className="block font-bold text-slate-800 text-lg">{new Date(evt.start.dateTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                                                    <span className="block text-xs text-slate-400 font-medium">{new Date(evt.end.dateTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                                                </div>
                                                                <div className="flex-1 bg-white border border-slate-100 p-5 rounded-xl hover:border-[#003B6E] hover:shadow-md transition relative overflow-hidden">
                                                                    <div className="absolute left-0 top-0 bottom-0 w-1 bg-[#003B6E]"></div>
                                                                    <h4 className="font-bold text-slate-800 text-lg mb-2">{evt.subject}</h4>
                                                                    <div className="flex flex-wrap gap-4 text-sm text-slate-500">
                                                                        {evt.location?.displayName && <span className="flex items-center gap-1.5"><MapPin size={14} className="text-[#003B6E]" /> {evt.location.displayName}</span>}
                                                                        <span className="flex items-center gap-1.5"><Clock size={14} className="text-[#003B6E]" /> {Math.round((new Date(evt.end.dateTime) - new Date(evt.start.dateTime))/60000)} Minuten</span>
                                                                        {evt.organizer && <span className="flex items-center gap-1.5"><Users size={14} className="text-[#003B6E]" /> {evt.organizer.emailAddress.name}</span>}
                                                                    </div>
                                                                    
                                                                    <div className="mt-3 flex gap-2">
                                                                        {evt.isOnlineMeeting && <div className="inline-block bg-blue-50 text-[#003B6E] text-xs font-bold px-2 py-1 rounded">Teams Meeting</div>}
                                                                        {evt.teamsLink && (
                                                                            <a href={evt.teamsLink} target="_blank" className="inline-flex items-center gap-1 text-[10px] font-bold text-white bg-[#5b5fc7] hover:bg-[#4f52b2] px-2 py-1 rounded transition">
                                                                                <Video size={10} /> Jetzt teilnehmen
                                                                            </a>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* ================= NEWS FULL VIEW ================= */}
                            {activeTab === 'news' && (
                                <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col min-h-[80vh] fade-in">
                                    <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl">
                                        <h2 className="text-2xl font-bold text-[#003B6E] flex items-center gap-3"><Globe size={28} /> GTAI Intranet News</h2>
                                        <a href="https://gtai.sharepoint.com/sites/GTAI-Intranet" target="_blank" className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50 transition flex items-center gap-2">
                                            Zum Intranet <ExternalLink size={14} />
                                        </a>
                                    </div>
                                    <div className="p-8 space-y-6 flex-1">
                                        {intranetNews.map(news => (
                                            <a key={news.id} href={news.url} target="_blank" className="block bg-white border border-slate-100 p-5 rounded-xl hover:border-[#003B6E] hover:shadow-md transition relative overflow-hidden group">
                                                <div className="absolute left-0 top-0 bottom-0 w-1 bg-[#003B6E] group-hover:bg-[#E4002B] transition-colors"></div>
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="text-xs font-bold uppercase tracking-wider text-slate-400">{news.date}</span>
                                                    <span className="text-[10px] font-bold uppercase tracking-wider text-[#003B6E] bg-blue-50 px-2 py-1 rounded">{news.category}</span>
                                                </div>
                                                <h3 className="text-lg font-bold text-slate-800 mb-1 group-hover:text-[#003B6E] transition-colors">{news.title}</h3>
                                                <p className="text-sm text-slate-500">{news.summary}</p>
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            )}

                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <MsalProvider instance={msalInstance}>
                    <MainContent />
                </MsalProvider>
            </ErrorBoundary>
        );
    </script>
</body>
</html>
