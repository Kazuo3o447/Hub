<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTAI Hub (Connected)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "@azure/msal-browser": "https://esm.sh/@azure/msal-browser@3.10.0",
        "@azure/msal-react": "https://esm.sh/@azure/msal-react@2.0.12?external=react,react-dom,@azure/msal-browser"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { PublicClientApplication } from "@azure/msal-browser";
        import { MsalProvider, useMsal, useIsAuthenticated } from "@azure/msal-react";
        import { 
            LayoutDashboard, LogOut, Globe, CheckCircle, Menu, X, Calendar, 
            MessageSquare, Zap, Newspaper, Bell, ListTodo, Plus, Trash2, 
            CheckSquare, Loader2, RefreshCw, Briefcase, Bot, ArrowRight,
            ExternalLink, FileText, MapPin, Video, Users, Clock, AlertTriangle, CalendarClock
        } from 'lucide-react';

        // --- 1. CONFIG ---
        const msalConfig = {
            auth: {
                clientId: "1bcff9d8-08fd-4807-9483-eeeab557d612",
                authority: "https://login.microsoftonline.com/7e77266e-8abb-4947-be1a-ce8f3bd5cb49",
                redirectUri: window.location.origin, 
            },
            cache: { cacheLocation: "sessionStorage" }
        };

        // Wir fordern echte Schreibrechte an!
        const loginRequest = {
            scopes: ["User.Read", "Calendars.ReadWrite", "Tasks.ReadWrite", "Sites.Read.All"] 
        };

        const msalInstance = new PublicClientApplication(msalConfig);
        if (!msalInstance.getActiveAccount() && msalInstance.getAllAccounts().length > 0) {
            msalInstance.setActiveAccount(msalInstance.getAllAccounts()[0]);
        }

        // --- HELPER: GRAPH API CALLER ---
        // Diese Funktion ist der Schl√ºssel. Sie holt das Token und macht den Call.
        async function callMsGraph(instance, accounts, endpoint, method = "GET", body = null) {
            const request = {
                ...loginRequest,
                account: accounts[0]
            };

            try {
                const response = await instance.acquireTokenSilent(request);
                const headers = new Headers();
                const bearer = `Bearer ${response.accessToken}`;
                headers.append("Authorization", bearer);
                if (body) headers.append("Content-Type", "application/json");

                const options = {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                };

                const graphResponse = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, options);
                
                if (!graphResponse.ok) throw new Error(`Graph Error: ${graphResponse.statusText}`);
                
                // Manche Calls (z.B. Photo) geben Blob zur√ºck, andere JSON
                const contentType = graphResponse.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return await graphResponse.json();
                } else if (contentType && contentType.indexOf("image") !== -1) {
                    return await graphResponse.blob();
                }
                return await graphResponse.text();

            } catch (error) {
                console.error("Graph API Error:", error);
                throw error;
            }
        }

        // --- HAUPT APP ---
        const MainContent = () => {
            const { instance, accounts } = useMsal();
            const isAuthenticated = useIsAuthenticated();
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            // Echte Daten States
            const [userProfile, setUserProfile] = useState({ displayName: "", jobTitle: "", mail: "", photoUrl: null });
            const [calendarEvents, setCalendarEvents] = useState([]);
            const [plannerTasks, setPlannerTasks] = useState([]);
            const [isLoadingData, setIsLoadingData] = useState(false);

            // Lokale States (To-Do, Chat etc.)
            const [todos, setTodos] = useState([]);
            const [newTodoText, setNewTodoText] = useState('');
            const [isBlocker, setIsBlocker] = useState(false);
            const [messages, setMessages] = useState([{ sender: 'bot', text: "Hallo! Ich bin Dexter. Ich habe Zugriff auf deine echten M365 Daten." }]);
            const [dexterInput, setDexterInput] = useState('');

            // --- INITIAL LOAD ---
            useEffect(() => {
                if (isAuthenticated && accounts[0]) {
                    loadAllData();
                }
            }, [isAuthenticated, accounts]);

            const loadAllData = async () => {
                setIsLoadingData(true);
                try {
                    // 1. Profil laden
                    const profile = await callMsGraph(instance, accounts, "/me");
                    let photoUrl = null;
                    try {
                        const photoBlob = await callMsGraph(instance, accounts, "/me/photo/$value");
                        photoUrl = URL.createObjectURL(photoBlob);
                    } catch (e) { console.log("Kein Profilbild gefunden"); }
                    
                    setUserProfile({ ...profile, photoUrl });

                    // 2. Kalender laden (N√§chste 7 Tage)
                    const start = new Date().toISOString();
                    const end = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
                    const calData = await callMsGraph(instance, accounts, `/me/calendarview?startDateTime=${start}&endDateTime=${end}&$top=10&$orderby=start/dateTime`);
                    setCalendarEvents(calData.value || []);

                    // 3. Planner Tasks laden
                    const taskData = await callMsGraph(instance, accounts, "/me/planner/tasks");
                    setPlannerTasks(taskData.value || []);

                } catch (e) {
                    console.error("Daten konnten nicht geladen werden", e);
                } finally {
                    setIsLoadingData(false);
                }
            };

            // --- REAL ACTION: WRITE TO CALENDAR ---
            const createCalendarBlocker = async (title) => {
                const start = new Date(); // Jetzt
                const end = new Date(start.getTime() + 60 * 60 * 1000); // +1 Stunde

                const event = {
                    subject: `üõ°Ô∏è FOKUS: ${title}`,
                    start: { dateTime: start.toISOString(), timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
                    end: { dateTime: end.toISOString(), timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
                    importance: "High"
                };

                try {
                    await callMsGraph(instance, accounts, "/me/events", "POST", event);
                    alert("Blocker erfolgreich in Outlook erstellt!");
                    loadAllData(); // Refresh Calendar
                } catch (e) {
                    alert("Fehler beim Erstellen des Blockers: " + e.message);
                }
            };

            const handleAddTodo = (e) => {
                e.preventDefault();
                if (!newTodoText.trim()) return;
                const newTodo = { id: Date.now(), text: newTodoText, isBlocker };
                setTodos([...todos, newTodo]);
                
                if (isBlocker) {
                    createCalendarBlocker(newTodoText);
                }
                
                setNewTodoText('');
                setIsBlocker(false);
            };

            const getFirstName = () => userProfile.displayName ? userProfile.displayName.split(',')[1]?.trim() || userProfile.displayName.split(' ')[0] : "Gast";

            // --- RENDER LOGIN ---
            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100">
                        <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full">
                            <Globe className="w-16 h-16 text-[#003366] mx-auto mb-4" />
                            <h1 className="text-2xl font-bold text-[#003366] mb-2">GTAI Hub (Live Data)</h1>
                            <p className="text-sm text-gray-500 mb-6">Verbindet sich mit Ihrem echten Microsoft 365 Account.</p>
                            <div className="bg-blue-50 text-blue-800 text-xs p-2 rounded border border-blue-200 mb-4 break-all">
                                Redirect URI: {window.location.origin}
                            </div>
                            <button onClick={() => instance.loginPopup(loginRequest)} className="w-full bg-[#003366] text-white p-3 rounded hover:bg-blue-900 transition flex justify-center items-center gap-2">
                                <span>üîí</span> Mit Microsoft anmelden
                            </button>
                        </div>
                    </div>
                );
            }

            // --- RENDER DASHBOARD ---
            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden">
                    {/* SIDEBAR */}
                    <aside className={`bg-[#003366] text-white flex flex-col transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                        <div className="p-4 flex items-center justify-between border-b border-blue-800/50">
                            {isSidebarOpen && <span className="font-bold flex items-center gap-2"><Globe /> GTAI HUB</span>}
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-1 hover:bg-blue-800 rounded"><Menu size={20} /></button>
                        </div>
                        <nav className="flex-1 py-4 space-y-1 px-2">
                            {[
                                { id: 'dashboard', icon: <LayoutDashboard />, label: 'Dashboard' },
                                { id: 'tasks', icon: <CheckCircle />, label: 'Planner & ToDo' },
                                { id: 'calendar', icon: <Calendar />, label: 'Kalender' },
                                { id: 'copilot', icon: <Bot />, label: 'Dexter Agent' }
                            ].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 p-3 rounded transition ${activeTab === item.id ? 'bg-blue-500' : 'hover:bg-blue-800/50'} ${!isSidebarOpen && 'justify-center'}`}>
                                    {item.icon} {isSidebarOpen && <span>{item.label}</span>}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-blue-800/50 flex items-center gap-3">
                            {userProfile.photoUrl ? (
                                <img src={userProfile.photoUrl} className="w-10 h-10 rounded-full border-2 border-white/20" />
                            ) : (
                                <div className="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold">{getFirstName().substring(0,2)}</div>
                            )}
                            {isSidebarOpen && <div className="overflow-hidden"><p className="text-sm font-bold truncate">{getFirstName()}</p><button onClick={() => instance.logoutPopup()} className="text-xs text-blue-300 hover:text-white flex items-center gap-1"><LogOut size={10} /> Logout</button></div>}
                        </div>
                    </aside>

                    {/* MAIN */}
                    <main className="flex-1 flex flex-col h-full">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-6">
                            <h2 className="text-xl font-bold capitalize text-slate-800">{activeTab}</h2>
                            <div className="flex items-center gap-4">
                                <button onClick={loadAllData} className={`p-2 rounded-full hover:bg-slate-100 ${isLoadingData && 'animate-spin text-blue-600'}`}><RefreshCw size={20}/></button>
                                <span className="text-sm text-gray-500">{userProfile.jobTitle || "Mitarbeiter"}</span>
                            </div>
                        </header>

                        <div className="flex-1 overflow-auto p-6">
                            {activeTab === 'dashboard' && (
                                <div className="max-w-6xl mx-auto space-y-6">
                                    <div className="bg-gradient-to-r from-[#003366] to-[#00509e] rounded-2xl p-8 text-white relative overflow-hidden shadow-lg">
                                        <div className="relative z-10">
                                            <h1 className="text-3xl font-bold mb-2">Hallo {getFirstName()}!</h1>
                                            <p className="mb-6 opacity-90">Hier sind Ihre echten Daten aus der Microsoft Cloud.</p>
                                            <form onSubmit={(e) => { e.preventDefault(); setActiveTab('copilot'); setMessages(p => [...p, {sender:'user', text: dexterInput}]); }} className="flex gap-2 max-w-md">
                                                <input value={dexterInput} onChange={e => setDexterInput(e.target.value)} placeholder="Frag Dexter etwas..." className="flex-1 px-4 py-2 rounded text-slate-900 outline-none" />
                                                <button className="bg-white/20 hover:bg-white/30 px-4 rounded font-bold">Go</button>
                                            </form>
                                        </div>
                                        <Bot size={150} className="absolute -right-5 -bottom-5 opacity-10 rotate-12" />
                                    </div>

                                    {/* LIVE DATA GRID */}
                                    <div className="grid md:grid-cols-2 gap-6">
                                        {/* CALENDAR PREVIEW */}
                                        <div className="bg-white p-6 rounded-xl shadow border border-slate-200">
                                            <div className="flex justify-between mb-4">
                                                <h3 className="font-bold flex gap-2"><Calendar className="text-[#003366]" /> N√§chste Termine</h3>
                                                <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Live aus Outlook</span>
                                            </div>
                                            <div className="space-y-3">
                                                {calendarEvents.length === 0 ? <p className="text-gray-400 text-sm">Keine Termine gefunden.</p> : 
                                                 calendarEvents.slice(0, 3).map(evt => (
                                                    <div key={evt.id} className="flex gap-3 text-sm p-2 hover:bg-slate-50 rounded">
                                                        <div className="font-bold text-slate-500 w-12 text-right">
                                                            {new Date(evt.start.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                        </div>
                                                        <div className="border-l-2 border-blue-500 pl-3">
                                                            <div className="font-semibold truncate">{evt.subject}</div>
                                                            <div className="text-xs text-gray-500">{evt.location?.displayName || "Online"}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* PLANNER PREVIEW */}
                                        <div className="bg-white p-6 rounded-xl shadow border border-slate-200">
                                            <div className="flex justify-between mb-4">
                                                <h3 className="font-bold flex gap-2"><CheckCircle className="text-[#003366]" /> Meine Aufgaben</h3>
                                                <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Live aus Planner</span>
                                            </div>
                                            <div className="space-y-3">
                                                {plannerTasks.length === 0 ? <p className="text-gray-400 text-sm">Keine offenen Planner-Aufgaben.</p> : 
                                                 plannerTasks.slice(0, 3).map(task => (
                                                    <div key={task.id} className="flex justify-between items-center p-2 border-b last:border-0">
                                                        <span className="text-sm truncate">{task.title}</span>
                                                        {task.dueDateTime && <span className="text-xs text-red-500 flex gap-1"><Clock size={12}/> {new Date(task.dueDateTime).toLocaleDateString()}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* INTRANET NEWS MOCK (Da Site-ID spezifisch ist) */}
                                    <div className="bg-white p-6 rounded-xl shadow border border-slate-200">
                                        <h3 className="font-bold mb-4 flex gap-2"><Globe className="text-[#003366]" /> GTAI Intranet News</h3>
                                        <div className="grid md:grid-cols-3 gap-4">
                                            {["Neue Reiserichtlinien 2025", "IT-Wartung am Wochenende", "Erfolg auf der Hannover Messe"].map((news, i) => (
                                                <div key={i} className="border p-3 rounded hover:bg-slate-50 cursor-pointer">
                                                    <span className="text-[10px] uppercase text-blue-600 font-bold">News</span>
                                                    <p className="font-medium text-sm mt-1">{news}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'tasks' && (
                                <div className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow border">
                                    <h2 className="text-xl font-bold mb-6 flex gap-2"><ListTodo /> Pers√∂nliche To-Do & Blocker</h2>
                                    <form onSubmit={handleAddTodo} className="bg-slate-50 p-4 rounded mb-6 flex gap-2 items-center">
                                        <input value={newTodoText} onChange={e=>setNewTodoText(e.target.value)} placeholder="Aufgabe..." className="flex-1 p-2 rounded border" />
                                        <label className="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" checked={isBlocker} onChange={e=>setIsBlocker(e.target.checked)} /> Als Blocker in Outlook eintragen</label>
                                        <button className="bg-[#003366] text-white px-4 py-2 rounded hover:bg-blue-900"><Plus size={18}/></button>
                                    </form>
                                    <div className="space-y-2">
                                        {todos.map(t => (
                                            <div key={t.id} className="flex justify-between p-3 border rounded items-center">
                                                <span>{t.text} {t.isBlocker && "üõ°Ô∏è"}</span>
                                                <button onClick={() => setTodos(todos.filter(x=>x.id !== t.id))} className="text-red-500"><Trash2 size={16}/></button>
                                            </div>
                                        ))}
                                        {todos.length === 0 && <p className="text-gray-400 text-center text-sm">Liste leer.</p>}
                                    </div>
                                </div>
                            )}

                            {/* Weitere Tabs hier gek√ºrzt f√ºr √úbersichtlichkeit */}
                            {activeTab === 'copilot' && (
                                <div className="h-full flex flex-col bg-white rounded-xl shadow border">
                                    <div className="flex-1 p-6 overflow-y-auto">
                                        {messages.map((m, i) => (
                                            <div key={i} className={`mb-4 p-3 rounded-lg max-w-[80%] ${m.sender === 'user' ? 'ml-auto bg-blue-100 text-blue-900' : 'bg-slate-100'}`}>
                                                <strong>{m.sender === 'user' ? getFirstName() : 'Dexter'}:</strong> <br/> {m.text}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<MsalProvider instance={msalInstance}><MainContent /></MsalProvider>);
    </script>
</body>
</html>
